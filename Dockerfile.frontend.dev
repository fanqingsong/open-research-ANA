# Next.js Frontend Development Dockerfile
FROM swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/node:18-alpine AS base

# Configure Alpine to use Chinese mirrors for faster downloads
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Configure npm to use Chinese mirrors
RUN npm config set registry https://registry.npmmirror.com

# Install pnpm globally
RUN npm install -g pnpm

# Install dependencies based on the preferred package manager
COPY frontend/package.json frontend/pnpm-lock.yaml* ./
RUN pnpm config set registry https://registry.npmmirror.com && pnpm install --no-frozen-lockfile

# Copy source code
COPY frontend/ .

# Expose port
EXPOSE 3000

# Set environment variables
ENV NODE_ENV development
ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

# Start the development server
CMD ["pnpm", "run", "dev"]
